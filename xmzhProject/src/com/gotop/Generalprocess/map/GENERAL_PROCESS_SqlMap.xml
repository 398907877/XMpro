<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="GENERAL_PROCESS_SqlMap" >
	<resultMap id="omOrganization_result" class="com.gotop.vo.tyjg.Omorganization" >
    	<!--Bean方式返回全表-->
    	<result column="ORGID" property="orgid" jdbcType="DECIMAL" />
    	<result column="ORGCODE" property="orgCode" jdbcType="VARCHAR" />
    	<result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
 	 </resultMap>
   <resultMap id="TGeneralProcess_HashMapResult" class="java.util.HashMap" >
    <!--HashMap方式返回全表-->
    <result column="ID" property="id" jdbcType="DECIMAL" />
    <result column="EXECUTION_ID" property="executionId" jdbcType="VARCHAR" />
    <!-- <result column="TASK_ID" property="taskId" jdbcType="VARCHAR" /> -->
    <result column="PRE_TASK_ID" property="preTaskId" jdbcType="VARCHAR" />
    <result column="PRE_TASK_ASSINGEE" property="preTaskAssingee" jdbcType="DECIMAL" />
    <result column="PRE_TASK_ORG" property="preTaskOrg" jdbcType="DECIMAL" />
    <result column="PRE_TASK_TIME" property="preTaskTime" jdbcType="VARCHAR" />
    <result column="NEXT_TASK_ID" property="nextTaskId" jdbcType="VARCHAR" />
     <result column="BUSINESS_KEY" property="businessKey" jdbcType="DECIMAL" />
    <result column="BUSINESS_TYPE" property="businessType" jdbcType="VARCHAR" />
     <result column="preTaskOrgName" property="preTaskOrgName" jdbcType="VARCHAR" />
      <result column="preTaskAssingeeName" property="preTaskAssingeeName" jdbcType="VARCHAR" />
      <result column="processName" property="processName" jdbcType="VARCHAR" />
      <result column="activityName" property="activityName" jdbcType="VARCHAR" />
      <result column="currentAssingee" property="currentAssingee" jdbcType="VARCHAR"/>
      <result column="currentActivityName" property="currentActivityName" jdbcType="VARCHAR" />
       <result column="BUSINESS_TITLE" property="businessTitle" jdbcType="VARCHAR" />
       <result column="BEGIN_EMPID" property="beginEmpId" jdbcType="VARCHAR" />
       <result column="BEGIN_ORGID" property="beginOrgId" jdbcType="VARCHAR" />
       <result column="CUST_NAME" property="cust_Name" jdbcType="VARCHAR" />
       <result column="CURRENCY" property="currency" jdbcType="VARCHAR" />
       <result column="APPLY_BAL" property="apply_bal" jdbcType="VARCHAR" />
       <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
       <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
       <result column="beginEmpname" property="beginEmpname" jdbcType="VARCHAR" />
       <result column="beginOrgname" property="beginOrgname" jdbcType="VARCHAR" />
       <result column="SUPPORT_CATEGORY" property="supportCategory" jdbcType="VARCHAR" />
  </resultMap>
  
  	
  
  
  	<!-- 查询营销人员机构 -->
  	<select id="queryyxryjg" resultClass="java.util.HashMap" parameterClass="java.util.HashMap">
  	
  	select g.orgname as yxryjg
  from om_organization G, om_employee O, ac_operator A

 WHERE G.ORGID = O.ORGID
   AND O.EMPID = A.EMPID
   
      <isNotNull prepend="and" property="yxry" >
              a.operatorname = #yxry#
      		</isNotNull>
  
  	
  	</select>
  	
  	<!-- 根据员工号查询出其所属机构名称 -->
  	<select id="queryOrgName" resultClass="java.util.HashMap" parameterClass="String">
  		select b.orgname from om_emporg a,om_organization b where a.empid in($empIds$) and b.orgid = a.orgid
  	</select>
  	
  	<select id="isHaveParentOrgId" resultClass="String" parameterClass="java.util.HashMap">
  		select a.parentorgid
  from om_organization a
 where a.orgid =
       (select t.parentorgid from om_organization t where t.orgcode = #orgcode#)
  	</select>
  	
  	<select id="getParentOrgId" resultMap="omOrganization_result" parameterClass="java.util.HashMap">
  		select a.orgid,a.orgcode,a.orgname
  from om_organization a
 where a.orgid =
       (select t.parentorgid from om_organization t where t.orgcode = #orgcode#)
  	</select>
  
  	 <select id="queryGeneralprocessList" resultMap="TGeneralProcess_HashMapResult" parameterClass="java.util.HashMap">
  		SELECT T11.*,v.begin_empid,
               v.begin_orgid,
               v.cust_name,
               v.currency,
               v.apply_bal/10000 as apply_bal,
               v.onecategory,
               v.loancategory,
               v.support_category,
                T10.NEXT_ORG_NAME AS preTaskOrgName,
               v.orgname as beginEmpname,
               v.empname as beginOrgname FROM 
               (select *
  from (select T1.ID,
               T1.EXECUTION_ID,
               T1.TASK_ID,
               T1.PRE_TASK_ID,
               T1.PRE_TASK_ASSINGEE,
               T1.PRE_TASK_ORG,
               T1.PRE_TASK_TIME,
               T1.NEXT_TASK_ID,
               T1.BUSINESS_KEY,
               T3.EMPNAME AS preTaskAssingeeName,
               t6.process_name AS processName,
               t9.business_title,
               t6.business_type,
               t8.activity_name_ AS activityName,
               t1.NEXT_ACTIVITY_NAME as currentActivityName,
               to_char(T8.START_, 'yyyymmddhh24miss') AS startTime,
               to_char(T8.END_, 'yyyymmddhh24miss') AS endTime,
               t1.NEXT_ASSINGEE_NAME as currentAssingee,
               T8.END_,
               row_number() over(partition by t1.execution_id order by t1.id desc) rn
          from JBPM4_HIST_PROCINST     t5,
               T_PROCESS_CONFIG        t6,
               T_PROCESS_BUSINESS      t9,
               T_PROCESS_TASK_ASSIGNEE t1,
               JBPM4_HIST_TASK         t7,
               om_employee             t3,
               OM_ORGANIZATION         T4,
               JBPM4_HIST_ACTINST      t8
         where t5.procdefid_ = t6.definition_id
           and t9.execution_id = t5.id_
           and t1.execution_id = t9.execution_id
           and t7.execution_ = t1.execution_id
           and t3.empid = t1.pre_task_assingee
           AND T9.BUSINESS_TYPE=88
           and t8.htask_ = t1.pre_task_id
           <isNotNull prepend="and" property="empId" >
              t9.submit_id= $empId$
      		</isNotNull>
           )
 where rn = 1
) T11,V_APP_CONDITION V2,V_GENERALPROCESS_XD V,<!--  (select minoperater_date,o1.flow_id,o1.operator_type,o1.operater_date,o1.next_org_name,o1.node_id
  from t_approve_opninion_gp o1,
      (select o.flow_id, min(o.operater_date) as minoperater_date
         T_APPROVE_OPNINION_GP t10
          from T_APPROVE_OPNINION_GP o
         group by o.flow_id) o2
         where o1.flow_id=o2.flow_id) t10 -->
         T_APPROVE_OPNINION_GP t10
 WHERE T11.EXECUTION_ID=V2.execution_id(+)
 AND T11.EXECUTION_ID=V.flow_id(+) 
 and t10.flow_id=T11.EXECUTION_ID
  			<isNotNull prepend="and" property="orgcode" >
              v.begin_orgid in( select orgid from om_organization 
     			start with orgcode = #orgcode#
    			connect by prior orgid = parentorgid)
      		</isNotNull>
           <isNotNull prepend="and" property="appTimeStrat" >
           	<![CDATA[
           		T11.EXECUTION_ID in(select t12.flow_id from T_APPROVE_OPNINION_GP t12 where 
           		t12.operator_type='提交发起合同预审' 
           		and t12.operater_date>='$appTimeStrat$')
               ]]>
      		</isNotNull>
           <isNotNull prepend="and" property="appTimeEnd" >
           	<![CDATA[
            	T11.EXECUTION_ID in(select t12.flow_id from T_APPROVE_OPNINION_GP t12 where 
           		t12.operator_type='提交发起合同预审' 
           		and t12.operater_date<='$appTimeEnd$')
               ]]>
      		</isNotNull>
           <isNotNull prepend="and" property="reporttimeStrat" >
           	 <![CDATA[
            	v.reporttime>='$reporttimeStrat$'
               ]]>
      		</isNotNull>
           <isNotNull prepend="and" property="reporttimeEnd" >
           	<![CDATA[
            	v.reporttime<='$reporttimeEnd$'
               ]]>
      		</isNotNull>
           <isNotNull prepend="and" property="orgCodeOne" >
           	v.orgCodeOne='$orgCodeOne$'
      		</isNotNull>
           <isNotNull prepend="and" property="orgCodeTwo" >
           	v.orgCodeTwo='$orgCodeTwo$'
      		</isNotNull>
           <isNotNull prepend="and" property="cust_Name" >
           	v.cust_Name like '%'||'$cust_Name$'||'%'
      		</isNotNull>
           <isNotNull prepend="and" property="isEnd" >
           	<isEqual property="isEnd" compareValue="0">
           	    t11.currentActivityName!='结束'
           	</isEqual>
           	<isEqual property="isEnd" compareValue="1">
           	    t11.currentActivityName='结束'
           	</isEqual>
      		</isNotNull>
           <isNotNull prepend="and" property="creator" >
           	v.creator='$creator$'
      		</isNotNull>
           <isNotNull prepend="and" property="fdxdy" >
           	v.fdxdy='$fdxdy$'
      		</isNotNull>
           <isNotNull prepend="and" property="supportCategory" >
           v.support_category in($supportCategory$)
      		</isNotNull>
           <isNotNull prepend="and" property="oneCategory" >
           	 v.onecategory in(select dic.dictname from eos_dict_entry dic where dic.dicttypeid='PROCESS_onecategory' 
           	 and dic.dictid in($oneCategory$))
      		</isNotNull>
      		 <isNotNull prepend="and" property="loanCategory" >
           	 v.onecategory in(select dic.dictname from eos_dict_entry dic where dic.dicttypeid='PROCESS_credit_type' 
           	 and dic.dictid in($loanCategory$))
      		</isNotNull>
		<isNotNull prepend="and" property="dyApp" >
           	v2.sp1='$dyApp$'
      		</isNotNull>
           <isNotNull prepend="and" property="deApp" >
           	v2.sp2='$dyApp$'
      		</isNotNull>
           <isNotNull prepend="and" property="dyCheck" >
           v2.sc1='$dyCheck$'
      		</isNotNull>
           <isNotNull prepend="and" property="deCheck" >
           	v2.sc2='$deCheck$'
      		</isNotNull>
           <isNotNull prepend="and" property="processName" >
           t11.processName like '%'||'$processName$'||'%'
      		</isNotNull>
          <!--  <isNotNull prepend="and" property="minoperaterDateEnd" >
               <![CDATA[
            	 	t10.minoperater_date<='$minoperaterDateEnd$'
               ]]>
      		</isNotNull>
           <isNotNull prepend="and" property="minoperaterDateStrat" >
           	<![CDATA[
            	 	t10.minoperater_date>='$minoperaterDateStrat$'
               ]]>
      		</isNotNull> -->
  and (t10.node_id=t11.next_task_id or t10.node_id is null )
  order by END_ desc
  	</select> 
  	
  	
</sqlMap>