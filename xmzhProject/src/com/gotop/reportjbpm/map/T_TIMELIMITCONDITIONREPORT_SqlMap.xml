<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="T_TIMELIMITCONDITIONREPORT_SqlMap">
 <resultMap id="timeLimitConditionReport" class="com.gotop.reportjbpm.model.TimeLimitConditionReport" >
    <!--Bean方式返回全表-->
    <result column="ORGNAMEONE" property="orgNameOne" jdbcType="VARCHAR" />
    <result column="ORGNAMETWO" property="orgNameTwo" jdbcType="VARCHAR" />
    <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
    <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
    <result column="ZDCUSTMANAGER" property="zdCustManager" jdbcType="VARCHAR" />
    <result column="ZHGPDTIMEONE" property="zhgpdTimeOne" jdbcType="VARCHAR" />
    <result column="ZHGPDTIMETWO" property="zhgpdTimeTwo" jdbcType="VARCHAR" />
    <result column="ZHGPDTIMETHREE" property="zhgpdTimeThree" jdbcType="VARCHAR" />
    <result column="REVIEWAPPROVALONETIME" property="reviewApprovalOneTime" jdbcType="VARCHAR" />
    <result column="REVIEWAPPROVALTWOTIME" property="reviewApprovalTwoTime" jdbcType="VARCHAR" />
    <result column="REVIEWAPPROVALTHREEORMORETIME" property="reviewApprovalThreeOrMoreTime" jdbcType="VARCHAR" />
    <result column="ALLPROCESSTIMEONE" property="allProcessTimeOne" jdbcType="VARCHAR" />
    <result column="ALLPROCESSTIMETWO" property="allProcessTimeTwo" jdbcType="VARCHAR" />
    <result column="ZLWZHAPPROVALTIME" property="zlwzhApprovalTime" jdbcType="VARCHAR" />
  </resultMap>
  
  
  
  	<!-- 查询时限情况统计报表 -->
	<select id="queryTimeLimitConditionReportList" parameterClass="java.util.HashMap" resultMap="timeLimitConditionReport">
	SELECT ORGNAMEONE,
       ORGCODEONE,
       ORGCODETWO,
       ORGNAMETWO,
       DISPLAYORDERONE,
       DISPLAYORDERTWO,
       ONECATEGORY,
       LOANCATEGORY,
       CREATORNAME ZDCUSTMANAGER,
       MAX(PDONE_start)||','||MAX(PDONE_end) ZHGPDTIMEONE,
       MAX(PDtwo_start)||','||MAX(PDtwo_end) ZHGPDTIMETWO,
       MAX(PDthree_start)||','||MAX(PDthree_end) ZHGPDTIMETHREE,
       MAX(REVIEWAPPROVALONETIME_start)||','||MAX(REVIEWAPPROVALONETIME_end) REVIEWAPPROVALONETIME,
       MAX(REVIEWAPPROVALTWOTIME_start)||','||MAX(REVIEWAPPROVALTWOTIME_end) REVIEWAPPROVALTWOTIME,
       MAX(REORMORETIME_start)||','||MAX(REORMORETIME_end) REVIEWAPPROVALTHREEORMORETIME,
       MAX(ALLPROCESSTIMEONE_start)||','||MAX(ALLPROCESSTIMEONE_end) ALLPROCESSTIMEONE,
       MAX(ALLPROCESSTIMETWO_start)||','||MAX(ALLPROCESSTIMETWO_end) ALLPROCESSTIMETWO,
       MAX(ZLWZHAPPROVALTIME_start)||','||MAX(ZLWZHAPPROVALTIME_end) ZLWZHAPPROVALTIME
FROM(
SELECT ORGNAMEONE,
               ORGCODEONE,
               ORGCODETWO,
               DISPLAYORDERONE,
               DISPLAYORDERTWO,
               ORGNAMETWO,
               ONECATEGORY,
               LOANCATEGORY,
               CREATORNAME,
            (CASE
                 WHEN rn = 1 AND
                      activity_name_last = '受理调查' and activity_name_next='收单派单' THEN
                  start_next
                 ELSE
                  '0'
               END) PDONE_start,
               
               (CASE
                 WHEN rn = 1 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  start_next
                 ELSE
                  '0'
               END) PDONE_end,
               
                (CASE
                 WHEN rn = 2 AND
                      activity_name_last = '受理调查' and activity_name_next='收单派单' THEN
                 start_next
                 ELSE
                  '0'
               END) PDtwo_start,
               
               (CASE
                 WHEN rn = 2 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  start_next
                 ELSE
                  '0'
               END) PDtwo_end,
               
               (CASE
                 WHEN rn = 3 AND
                      activity_name_last = '受理调查' and activity_name_next='收单派单' THEN
                  start_next
                 ELSE
                  '0'
               END) PDthree_start,
               
                (CASE
                 WHEN rn = 3 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  start_next
                 ELSE
                  '0'
               END) PDthree_end,
               
               (CASE
                 WHEN rn = 1 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  start_next
                 ELSE
                  '0'
               END) REVIEWAPPROVALONETIME_start,
               
                (CASE
                 WHEN rn = 1 AND
                      activity_name_last = '审查一' and activity_name_next='收单派单' THEN
                  start_next
                 WHEN rn = 1 AND
                      activity_name_last = '审批一' and activity_name_next='收单派单' THEN
                  start_next
                  WHEN rn = 1 AND
                      activity_name_last = '审查一' and activity_name_next='发起合同预审' THEN
                  start_next
                   WHEN rn = 1 AND
                      activity_name_last = '审批一' and activity_name_next='发起合同预审' THEN
                  start_next
                 ELSE
                  '0'
               END) REVIEWAPPROVALONETIME_end,
               
               
               (CASE
                 WHEN rn = 2 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  start_next
                 ELSE
                  '0'
               END) REVIEWAPPROVALTWOTIME_start,
               
                (CASE
                 WHEN rn = 2 AND
                      activity_name_last = '审查一' and activity_name_next='收单派单' THEN
                  start_next
                 WHEN rn = 2 AND
                      activity_name_last = '审批一' and activity_name_next='收单派单' THEN
                  start_next
                  WHEN rn = 2 AND
                      activity_name_last = '审查一' and activity_name_next='发起合同预审' THEN
                  start_next
                   WHEN rn = 2 AND
                      activity_name_last = '审批一' and activity_name_next='发起合同预审' THEN
                  start_next
                 ELSE
                  '0'
               END) REVIEWAPPROVALTWOTIME_end,
               
               
               
               (CASE
                 WHEN rn >= 3 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  start_next
                 ELSE
                  '0'
               END) REORMORETIME_start,
               
                (CASE
                 WHEN rn >= 3 AND
                      activity_name_last = '审查一' and activity_name_next='收单派单' THEN
                  start_next
                 WHEN rn >= 3 AND
                      activity_name_last = '审批一' and activity_name_next='收单派单' THEN
                  start_next
                  WHEN rn >= 3 AND
                      activity_name_last = '审查一' and activity_name_next='发起合同预审' THEN
                  start_next
                   WHEN rn >= 3 AND
                      activity_name_last = '审批一' and activity_name_next='发起合同预审' THEN
                  start_next
                 ELSE
                  '0'
               END) REORMORETIME_end,
               
               
               (CASE
                 WHEN rn = 1 AND
                      activity_name_last = '受理调查' and activity_name_next='收单派单' THEN
                  start_next
                 ELSE
                  '0'
               END) ALLPROCESSTIMEONE_start,
               
               
                 (CASE
                  WHEN rn = 1 AND
                      activity_name_last = '审查一' and activity_name_next='发起合同预审' THEN
                  start_next
                   WHEN rn = 1 AND
                      activity_name_last = '审批一' and activity_name_next='发起合同预审' THEN
                  start_next
                 ELSE
                  '0'
               END) ALLPROCESSTIMEONE_end,
               
               
               (CASE
                 WHEN rn = 1 AND
                      activity_name_last = '收单派单' and activity_name_next='审查一' THEN
                  end_next
                 ELSE
                  '0'
               END) ALLPROCESSTIMETWO_start,
               
               
                 (CASE
                  WHEN rn = 1 AND
                      activity_name_last = '审查一' and activity_name_next='发起合同预审' THEN
                  start_next
                   WHEN rn = 1 AND
                      activity_name_last = '审批一' and activity_name_next='发起合同预审' THEN
                  start_next
                 ELSE
                  '0'
               END) ALLPROCESSTIMETWO_end,
               
               
                 (CASE
                 WHEN 
                      activity_name_last = '受理调查' and activity_name_next='收单派单' THEN
                  start_next
                 ELSE
                  '0'
               END) ZLWZHAPPROVALTIME_start,
                (CASE
                  WHEN 
                      activity_name_last = '审查一' and activity_name_next='发起合同预审' THEN
                  start_next
                   WHEN 
                      activity_name_last = '审批一' and activity_name_next='发起合同预审' THEN
                  start_next
                 ELSE
                  '0'
               END) ZLWZHAPPROVALTIME_end,
               
               FLOW_ID,
               activity_name_last,
               activity_name_next,
               RN
          FROM (SELECT distinct O1.ORGNAME AS ORGNAMEONE,
                                T.ORGCODEONE,
                                T.ORGCODETWO,
                                O1.DISPLAYORDER AS DISPLAYORDERONE,
                                O2.DISPLAYORDER AS DISPLAYORDERTWO,
                                O2.ORGNAME AS ORGNAMETWO,
                                T.ONECATEGORY,
                                T.LOANCATEGORY,
                                E1.EMPNAME AS CREATORNAME,
                                to_char(j1.start_, 'yyyyMMddHHmiss') start_next,
                                to_char(j1.end_, 'yyyyMMddHHmiss') end_next,
                                to_char(j2.start_, 'yyyyMMddHHmiss') start_last,
                                to_char(j2.end_, 'yyyyMMddHHmiss') end_last,
                                T.FLOW_ID,
                                j2.activity_name_ activity_name_last,
                                J1.ACTIVITY_NAME_ activity_name_next,
                                ROW_NUMBER() OVER(PARTITION BY T.ORGCODEONE, T.ORGCODETWO, T.ONECATEGORY, T.LOANCATEGORY, E1.EMPNAME, j2.activity_name_,T.FLOW_ID, J1.ACTIVITY_NAME_ ORDER BY j1.START_) RN
                  FROM  t_process_business b,
                  T_GENERALPROCESS_MODELONE T,
                       OM_ORGANIZATION           O1,
                       OM_ORGANIZATION           O2,
                       OM_EMPLOYEE               E1,
                       T_PROCESS_TASK_ASSIGNEE   P1,
                       JBPM4_HIST_ACTINST        J1,
                       JBPM4_HIST_ACTINST        j2,
                       T_GENERALPROCESS_MODELTHREE T3
                 WHERE B.EXECUTION_ID=T.FLOW_ID
                    AND T.ORGCODEONE = O1.ORGCODE
                   AND T.ORGCODETWO = O2.ORGCODE(+)
                   AND T.CREATOR = E1.EMPID
                   AND T.FLOW_ID = P1.EXECUTION_ID
                   AND B.EXECUTION_ID=T3.FLOW_ID
                   AND P1.BUSINESS_TYPE = '88'
                   AND t.flow_id = j1.execution_
                   AND t.flow_id = j2.execution_
                   and j1.HTASK_ = p1.next_task_id
                   and p1.PRE_TASK_ID=j2.htask_
                   
                   <isNotNull prepend="and" property="repTimeStart">
					   <![CDATA[T3.REPORTTIME>=#repTimeStart#]]>
				  </isNotNull> 
				   <isNotNull prepend="and" property="repTimeEnd" >                                    
                      <![CDATA[T3.REPORTTIME  <=(#repTimeEnd#)]]>
                   </isNotNull>
                   
                    <isNotNull prepend="and" property="orgCodeOne">
					  T.orgCodeOne='$orgCodeOne$'
				  </isNotNull>
				  <isNotNull prepend="and" property="orgCodeTwo">
					  T.orgCodeTwo='$orgCodeTwo$'
				  </isNotNull>
				  
                   <isNotNull prepend="and" property="oneCategory">
					  T.ONECATEGORY in ($oneCategory$)
				  </isNotNull>
				  <isNotNull prepend="and" property="loanCategory">
					  T.LOANCATEGORY in ($loanCategory$)
				  </isNotNull>
				  <isNotNull prepend="and" property="zdCustManager" >
                      E1.EMPNAME   like '%$zdCustManager$%'
                  </isNotNull>
                ))
 GROUP BY ORGNAMEONE,
          ORGCODEONE,
          DISPLAYORDERONE,
          DISPLAYORDERTWO,
          ORGCODETWO,
          ORGNAMETWO,
          ONECATEGORY,
          LOANCATEGORY,
          CREATORNAME
 order by DISPLAYORDERONE,DISPLAYORDERTWO
	
	</select>
      
     
	 

</sqlMap>