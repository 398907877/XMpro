<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="T_TIMELIMITCONDITIONREPORT_SqlMap">
 <resultMap id="timeLimitConditionReport" class="com.gotop.reportjbpm.model.TimeLimitConditionReport" >
    <!--Bean方式返回全表-->
    <result column="ORGNAMEONE" property="orgNameOne" jdbcType="VARCHAR" />
    <result column="ORGNAMETWO" property="orgNameTwo" jdbcType="VARCHAR" />
    <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
    <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
    <result column="ZDCUSTMANAGER" property="zdCustManager" jdbcType="NUMBER" />
    <result column="ZHGPDTIMEONE" property="zhgpdTimeOne" jdbcType="NUMBER" />
    <result column="ZHGPDTIMETWO" property="zhgpdTimeTwo" jdbcType="NUMBER" />
    <result column="ZHGPDTIMETHREE" property="zhgpdTimeThree" jdbcType="NUMBER" />
    <result column="REVIEWAPPROVALONETIME" property="reviewApprovalOneTime" jdbcType="NUMBER" />
    <result column="REVIEWAPPROVALTWOTIME" property="reviewApprovalTwoTime" jdbcType="NUMBER" />
    <result column="REVIEWAPPROVALTHREEORMORETIME" property="reviewApprovalThreeOrMoreTime" jdbcType="NUMBER" />
    <result column="ALLPROCESSTIMEONE" property="allProcessTimeOne" jdbcType="NUMBER" />
    <result column="ALLPROCESSTIMETWO" property="allProcessTimeTwo" jdbcType="NUMBER" />
    <result column="ZLWZHAPPROVALTIME" property="zlwzhApprovalTime" jdbcType="NUMBER" />
  </resultMap>
  
  
  
  	<!-- 查询时限情况统计报表 -->
	<select id="queryTimeLimitConditionReportList" parameterClass="java.util.HashMap" resultMap="timeLimitConditionReport">
	SELECT ORGNAMEONE,
       ORGCODEONE,
       ORGCODETWO,
       ORGNAMETWO,
       DISPLAYORDERONE,
       DISPLAYORDERTWO,
       ONECATEGORY,
       LOANCATEGORY,
       CREATORNAME ZDCUSTMANAGER,
       MAX(PDONE) ZHGPDTIMEONE,
       MAX(PDTWO) ZHGPDTIMETWO,
       MAX(PDTHREE) ZHGPDTIMETHREE,
       
       MAX(REVIEWAPPROVALONETIME) REVIEWAPPROVALONETIME,
       MAX(REVIEWAPPROVALTWOTIME) REVIEWAPPROVALTWOTIME,
       MAX(REVIEWAPPROVALTHREEORMORETIME) REVIEWAPPROVALTHREEORMORETIME,
            
       MAX(ALLPROCESSTIMEONE) ALLPROCESSTIMEONE,
       MAX(ALLPROCESSTIMETWO) ALLPROCESSTIMETWO,
       MAX(ZLWZHAPPROVALTIME) ZLWZHAPPROVALTIME
  FROM (SELECT ORGNAMEONE,
               ORGCODEONE,
               ORGCODETWO,
               DISPLAYORDERONE,
               DISPLAYORDERTWO,
               ORGNAMETWO,
               ONECATEGORY,
               LOANCATEGORY,
               CREATORNAME,
               (CASE
                 WHEN rn = 1 AND NEXT_ACTIVITY_NAME = '审查一' AND
                      activity_name_two = '受理调查' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) PDONE,
               (CASE
                 WHEN rn = 2 AND NEXT_ACTIVITY_NAME = '审查一' AND
                      activity_name_two = '受理调查' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) PDtwo,
               (CASE
                 WHEN rn = 3 AND NEXT_ACTIVITY_NAME = '审查一' AND
                      activity_name_two = '受理调查' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) PDthree,
               
               
               
               (CASE
                 WHEN rn = 1 AND NEXT_ACTIVITY_NAME = '发起合同预审' AND
                      activity_name_two = '审查一' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) REVIEWAPPROVALONETIME,
               (CASE
                 WHEN rn = 2 AND NEXT_ACTIVITY_NAME = '发起合同预审' AND
                      activity_name_two = '审查一' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) REVIEWAPPROVALTWOTIME,
               (CASE
                 WHEN rn = 3 AND NEXT_ACTIVITY_NAME = '发起合同预审' AND
                      activity_name_two = '审查一' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) REVIEWAPPROVALTHREEORMORETIME,
               
               
                 (CASE
                 WHEN rn = 1 AND NEXT_ACTIVITY_NAME = '发起合同预审' AND
                      activity_name_two = '受理调查' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) ALLPROCESSTIMEONE,
               (CASE
                 WHEN rn = 1 AND NEXT_ACTIVITY_NAME = '发起合同预审' AND
                      activity_name_two = '收单派单' and activity_name_one='审查一' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) ALLPROCESSTIMETWO,
               (CASE
                 WHEN rn >1 AND NEXT_ACTIVITY_NAME = '发起合同预审' AND
                      activity_name_two = '受理调查' and activity_name_one='收单派单' THEN
                  ROUND(TO_NUMBER(END_ - START_) * 24,2)
                 ELSE
                  0
               END) ZLWZHAPPROVALTIME,
               
               
               
               FLOW_ID,
               NEXT_ACTIVITY_NAME,
               activity_name_two,
               activity_name_one,
               RN
          FROM (SELECT distinct O1.ORGNAME AS ORGNAMEONE,
                                T.ORGCODEONE,
                                T.ORGCODETWO,
                                O1.DISPLAYORDER AS DISPLAYORDERONE,
                                O2.DISPLAYORDER AS DISPLAYORDERTWO,
                                O2.ORGNAME AS ORGNAMETWO,
                                T.ONECATEGORY,
                                T.LOANCATEGORY,
                                E1.EMPNAME AS CREATORNAME,
                                to_date(to_char(j1.start_, 'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') start_,
                                to_date(to_char(j1.end_, 'yyyy-mm-dd hh24:mi:ss'),'yyyy-mm-dd hh24:mi:ss') end_,
                                T.FLOW_ID,
                                P1.NEXT_ACTIVITY_NAME,
                                j2.activity_name_ activity_name_two,
                                J1.ACTIVITY_NAME_ activity_name_one,
                                ROW_NUMBER() OVER(PARTITION BY T.ORGCODEONE, T.ORGCODETWO, T.ONECATEGORY, T.LOANCATEGORY, P1.NEXT_ACTIVITY_NAME, E1.EMPNAME, j2.activity_name_, J1.ACTIVITY_NAME_ ORDER BY j1.START_) RN
                  FROM  t_process_business b,
                  T_GENERALPROCESS_MODELONE T,
                       OM_ORGANIZATION           O1,
                       OM_ORGANIZATION           O2,
                       OM_EMPLOYEE               E1,
                       T_PROCESS_TASK_ASSIGNEE   P1,
                       T_PROCESS_TASK_ASSIGNEE   p2,
                       JBPM4_HIST_ACTINST        J1,
                       JBPM4_HIST_ACTINST        j2,
                       T_GENERALPROCESS_MODELTHREE T3
                 WHERE B.EXECUTION_ID=T.FLOW_ID
                    AND T.ORGCODEONE = O1.ORGCODE
                   AND T.ORGCODETWO = O2.ORGCODE(+)
                   AND T.CREATOR = E1.EMPID
                   AND T.FLOW_ID = P1.EXECUTION_ID
                   AND T.FLOW_ID = P2.EXECUTION_ID
                   AND B.EXECUTION_ID=T3.FLOW_ID
                   AND P1.BUSINESS_TYPE = '88'
                   AND t.flow_id = j1.execution_
                   AND t.flow_id = j2.execution_
                   and j1.HTASK_ = p1.PRE_TASK_ID
                   and j1.htask_ = p2.next_task_id
                   and j2.htask_ = p2.pre_task_id
                   
                   <isNotNull prepend="and" property="repTimeStart">
					   <![CDATA[T3.REPORTTIME>=#repTimeStart#]]>
				  </isNotNull> 
				   <isNotNull prepend="and" property="repTimeEnd" >                                    
                      <![CDATA[T3.REPORTTIME  <=(#repTimeEnd#)]]>
                   </isNotNull>
                   
                    <isNotNull prepend="and" property="orgCodeOne">
					  T.orgCodeOne='$orgCodeOne$'
				  </isNotNull>
				  <isNotNull prepend="and" property="orgCodeTwo">
					  T.orgCodeTwo='$orgCodeTwo$'
				  </isNotNull>
				  
                   <isNotNull prepend="and" property="oneCategory">
					  T.ONECATEGORY in ($oneCategory$)
				  </isNotNull>
				  <isNotNull prepend="and" property="loanCategory">
					  T.LOANCATEGORY in ($loanCategory$)
				  </isNotNull>
				  <isNotNull prepend="and" property="zdCustManager" >
                      E1.EMPNAME   like '%$zdCustManager$%'
                  </isNotNull>
                ))
 GROUP BY ORGNAMEONE,
          ORGCODEONE,
          DISPLAYORDERONE,
          DISPLAYORDERTWO,
          ORGCODETWO,
          ORGNAMETWO,
          ONECATEGORY,
          LOANCATEGORY,
          CREATORNAME
 order by DISPLAYORDERONE,DISPLAYORDERTWO
	
	</select>
      
     
	 

</sqlMap>