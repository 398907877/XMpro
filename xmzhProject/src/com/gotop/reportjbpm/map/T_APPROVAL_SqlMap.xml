<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="T_APPROVAL_SqlMap">
 <resultMap id="approval" class="com.gotop.reportjbpm.model.Approval" >
    <!--Bean方式返回全表-->
    <result column="NEXTORGNAME" property="nextOrgName" jdbcType="VARCHAR" />
    <result column="REPORTTIME" property="reportTime" jdbcType="VARCHAR" />
    <result column="ISURGENT" property="isurgent" jdbcType="VARCHAR" />
    <result column="CUST_NAME" property="custName" jdbcType="VARCHAR" />
    <result column="OLD_CUST" property="oldCust" jdbcType="VARCHAR" />
    <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
    <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
    <result column="CURRENCY" property="currency" jdbcType="VARCHAR" />
    <result column="APPLY_BAL" property="applyBal" jdbcType="VARCHAR" />
    <result column="ORGNAMEONE" property="orgNameOne" jdbcType="VARCHAR" />
    <result column="ORGNAMETWO" property="orgNameTwo" jdbcType="VARCHAR" />
    <result column="YXRY" property="yxry" jdbcType="VARCHAR" />
    <result column="NEXT_OPR_NAME" property="nextOprName" jdbcType="VARCHAR" />
    <result column="FDXDY" property="fdxdy" jdbcType="VARCHAR" />
    <result column="SURVEY_TIME" property="surveyTime" jdbcType="VARCHAR" />
    <result column="APP_WAY" property="appWay" jdbcType="VARCHAR" />
    <result column="POL_NO" property="polNo" jdbcType="VARCHAR" />
    <result column="MEETING_COUNT" property="meetingCount" jdbcType="VARCHAR" />
    <result column="VOTE_NO" property="voteNo" jdbcType="VARCHAR" />
    <result column="APP_TIME" property="appTime" jdbcType="VARCHAR" />
    <result column="CON_MATTER" property="conMatter" jdbcType="VARCHAR" />
    <result column="DS_MS_ONE" property="dsMsOne" jdbcType="VARCHAR" />
    <result column="DS_MS_TWO" property="dsMsTwo" jdbcType="VARCHAR" />
    <result column="DY_APP" property="dyApp" jdbcType="VARCHAR" />
    <result column="DE_APP" property="deApp" jdbcType="VARCHAR" />
    <result column="HY_ZR_NAME" property="hyZrName" jdbcType="VARCHAR" />
    <result column="HY_WY_ONE" property="hyWyOne" jdbcType="VARCHAR" />
    <result column="SH_ADDR" property="shAddr" jdbcType="VARCHAR" />
    <result column="FX_TYPE" property="fxType" jdbcType="VARCHAR" />
    <result column="SP_TYPE" property="spType" jdbcType="VARCHAR" />
    <result column="YBJ_NUM" property="ybjNum" jdbcType="VARCHAR" />
    <result column="HY_SY_JL" property="hySyJl" jdbcType="VARCHAR" />
    <result column="PJ_JL" property="pjJl" jdbcType="VARCHAR" />
    <result column="FX_ED" property="fxEd" jdbcType="VARCHAR" />
    <result column="SX_ED" property="sxEd" jdbcType="VARCHAR" />
    <result column="YW_ED" property="ywEd" jdbcType="VARCHAR" />
    
    <result column="APPROVALTIME" property="approvalTime" jdbcType="VARCHAR" />
    <result column="CHECKONE" property="checkOne" jdbcType="VARCHAR" />
    <result column="CHECKTWO" property="checkTwo" jdbcType="VARCHAR" />
    <result column="CHECKTIME" property="checkTime" jdbcType="VARCHAR" />
    <result column="REPLYTIME" property="replyTime" jdbcType="VARCHAR" />
    <result column="RECEIVETIME" property="receiveTime" jdbcType="VARCHAR" />
  </resultMap>
  
	<!-- 查询受理审批台账 -->
	<select id="queryApprovalList" parameterClass="java.util.HashMap" resultMap="approval">
	
	SELECT Z.REPORTTIME,
       Z.ISURGENT,
       Z.CUST_NAME,
       Z.OLD_CUST,
       Z.ONECATEGORY,
       Z.LOANCATEGORY,
       Z.CURRENCY,
       Z.APPLY_BAL,
       Z.ORGNAMEONE,
       Z.FLOW_ID,
       Z.YXRY,
       Z.NEXT_OPR_NAME,
       Z.FDXDY,
       Z.APP_WAY,
       Z.SURVEY_TIME,
       Z.POL_NO,
       Z.MEETING_COUNT,
       Z.VOTE_NO,
       Z.APP_TIME,
       Z.CON_MATTER,
       Z.DS_MS_ONE,
       Z.DS_MS_TWO,
       Z.DY_APP,
       Z.DE_APP,
       Z.HY_ZR_NAME,
       Z.HY_WY_ONE,
       Z.SH_ADDR,
       Z.FX_TYPE,
       Z.SP_TYPE,
       Z.YBJ_NUM,
       Z.HY_SY_JL,
       Z.PJ_JL,
       Z.FX_ED,
       Z.SX_ED,
       Z.YW_ED,
       Z.NEXTORGNAME,
       O1.ORGNAMETWO,
       A1.APPROVALTIME,
       A2.CHECKTIME,
       A3.REPLYTIME,
       A4.CHECKONE,
       A5.CHECKTWO,
       A6.RECEIVETIME
  FROM (select T.REPORTTIME,
               T.ISURGENT,
               O.CUST_NAME,
               O.OLD_CUST,
               O.ONECATEGORY,
               O.LOANCATEGORY,
               O.CURRENCY,
               O.APPLY_BAL,
               N.ORGNAME AS ORGNAMEONE,
               O.FLOW_ID,
               O.YXRY,
               P.EMPNAME       AS NEXT_OPR_NAME,
               O.FDXDY,
               O.SURVEY_TIME,
               I.APP_WAY,
               I.POL_NO,
               I.MEETING_COUNT,
               I.VOTE_NO,
               I.APP_TIME,
               I.CON_MATTER,
               I.DS_MS_ONE,
               I.DS_MS_TWO,
               I.DY_APP,
               I.DE_APP,
               I.HY_ZR_NAME,
               I.HY_WY_ONE,
               I.SH_ADDR,
               I.FX_TYPE,
               I.SP_TYPE,
               I.YBJ_NUM,
               I.HY_SY_JL,
               I.PJ_JL,
               I.FX_ED,
               I.SX_ED,
               I.YW_ED,
               O2.NEXTORGNAME
          from (SELECT O.ORGNAME AS NEXTORGNAME, T.FLOW_ID
                  FROM T_GENERALPROCESS_MODELONE T
                       
                      ,
                       OM_ORGANIZATION O
                 WHERE O.ORGCODE = T.ORGCODEONE) O2,
               OM_EMPLOYEE P,
               T_GENERALPROCESS_MODELONE O,
               T_GENERALPROCESS_MODELTHREE T,
               T_GENERALPROCESS_MODELFIVE I,
               OM_ORGANIZATION N
         WHERE O2.FLOW_ID = O.FLOW_ID
           AND N.ORGCODE = O.ORGCODEONE
           AND O.CREATOR = P.EMPID
           AND O.FLOW_ID = T.FLOW_ID
           AND T.FLOW_ID = I.FLOW_ID) Z
           LEFT JOIN (SELECT O.ORGNAME AS ORGNAMETWO,T.FLOW_ID FROM T_GENERALPROCESS_MODELONE T ,OM_ORGANIZATION O WHERE O.ORGCODE=T.ORGCODETWO)O1
           ON O1.FLOW_ID=Z.FLOW_ID
           LEFT JOIN (select q.execution_,to_char(max(q.end_),'yyyy-mm-dd hh24:mi:ss ') as APPROVALTIME from jbpm4_hist_actinst q where q.activity_name_='发起合同预审' group by q.execution_)A1
           ON A1.EXECUTION_=Z.FLOW_ID
           LEFT JOIN (select q.execution_ ,to_char(max(q.start_),'yyyy-mm-dd hh24:mi:ss ') as CHECKTIME from jbpm4_hist_actinst q  where q.activity_name_='审查一' group by q.execution_)A2
           ON A2.EXECUTION_=Z.FLOW_ID
           LEFT JOIN (select A.EXECUTION_,(CASE WHEN T.YQ_APP_TIME IS NULL THEN A.REPLYTIME ELSE to_char(TO_DATE(t.yq_app_time, 'yyyy/MM/dd hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') END) AS REPLYTIME  from t_generalprocess_modelfive T,(select t.outcome_,to_char(q.start_ ,'yyyy-mm-dd hh24:mi:ss ') as REPLYTIME,t.execution_ from JBPM4_HIST_TASK t，jbpm4_hist_actinst q where t.outcome_='提交发起合同预审' and q.htask_=t.dbid_)A WHERE T.FLOW_ID=A.EXECUTION_)A3
           ON A3.EXECUTION_=Z.FLOW_ID
           LEFT JOIN （select t.execution_,o.empname as CHECKONE from jbpm4_hist_actinst q,JBPM4_HIST_TASK t,om_employee o WHERE q.activity_name_='审批一'and q.htask_=t.dbid_ and o.empid=t.assignee_ group by t.execution_,o.empname)A4
           ON A4.EXECUTION_=Z.FLOW_ID
           LEFT JOIN (select t.execution_,o.empname as CHECKTWO from jbpm4_hist_actinst q,JBPM4_HIST_TASK t,om_employee o WHERE q.activity_name_='审批二'and q.htask_=t.dbid_ and o.empid=t.assignee_ group by t.execution_,o.empname)A5
           ON A5.EXECUTION_=Z.FLOW_ID
           LEFT JOIN (select t.execution_, wm_concat(to_char(t.start_,'yyyy-mm-dd hh24:mi:ss')) RECEIVETIME from (select *from jbpm4_hist_actinst q where q.activity_name_ = '审查一' order by q.execution_, q.start_)T group by t.execution_)A6
           ON A6.EXECUTION_=Z.FLOW_ID where 1=1
   <isNotNull prepend="and" property="repTimeStrat">
   <![CDATA[Z.REPORTTIME>=#repTimeStrat#]]>
   </isNotNull>
   
   <isNotNull prepend="and" property="repTimeEnd">
   <![CDATA[Z.REPORTTIME<=#repTimeEnd#]]>
   </isNotNull>
      
      <isNotNull prepend="and" property="appTimeStrat" >
        <![CDATA[A1.APPROVALTIME>=#appTimeStrat#]]>
      </isNotNull>
      
      <isNotNull prepend="and" property="appTimeEnd" >
       <![CDATA[A1.APPROVALTIME<=#appTimeEnd#]]>
      </isNotNull>
	</select>
   
     
	 

</sqlMap>