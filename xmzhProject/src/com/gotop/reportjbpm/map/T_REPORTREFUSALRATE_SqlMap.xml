<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="T_REPORTREFUSALRATE_SqlMap">
 <resultMap id="ReportRefusalrate" class="com.gotop.reportjbpm.model.ReportRefusalrate" >
    <!--Bean方式返回全表-->
    <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
    <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
    <result column="ORGNAME" property="orgname" jdbcType="VARCHAR" />
    <result column="ORGNAMETWO" property="orgnametwo" jdbcType="VARCHAR" />
    <result column="EA_NUMBER" property="EA_number" jdbcType="VARCHAR" />
    <result column="REJECTION_NUMBER" property="rejection_number" jdbcType="VARCHAR" />
    <result column="REFUSALRATE" property="refusalrate" jdbcType="VARCHAR" />
  </resultMap>
  
 
	
	<!-- 查询拒贷信息 -->
	<select id="queryReportRefusalRate" parameterClass="java.util.HashMap" resultMap="ReportRefusalrate">
		
SELECT LOANCATEGORY,
       ORGNAME,
       ORGNAMETWO,
       EA_number,
       rejection_number,
       DECODE(refusalrate, '%', '0', refusalrate) refusalrate,
       REPORTTIME,
       ONECATEGORY
  FROM (      
        SELECT tt.LOANCATEGORY,
                tt.ORGNAME,
                tt.ORGNAMETWO,
                tt.REPORTTIME,
                tt.EA_number,
                gg.rejection_number,
                (round(gg.rejection_number /(tt.EA_number + gg.rejection_number) * 100,2)) || '%' as refusalrate,
                tt.ONECATEGORY
          from (SELECT t1.LOANCATEGORY,
                        t1.ONECATEGORY,
                        t2.ORGNAME,
                        t3.ORGNAMETWO,
                        t1.REPORTTIME,
                        count(*) EA_number
                   from (select T.flow_id,
                                T.ORGCODEONE,
                                T.ORGCODETWO,
                                T.LOANCATEGORY,
                                T.ONECATEGORY,
                                M.REPORTTIME
                           from T_GENERALPROCESS_MODELONE   T,
                                T_GENERALPROCESS_MODELTHREE M
                          where T.flow_id = M.flow_id) t1
                   join (SELECT ORGCODE, ORGNAME FROM OM_ORGANIZATION) t2
                     on t1.ORGCODEONE = t2.ORGCODE
                   LEFT join (SELECT ORGCODE as ORGCODETWO,
                                    ORGNAME as ORGNAMETWO
                               FROM OM_ORGANIZATION) t3
                     on t1.ORGCODETWO = t3.ORGCODETWO
                   JOIN (select a.execution_ f_id
                          from jbpm4_hist_actinst a
                         where a.transition_ = 'TO 结束'
                           and a.execution_ in
                               (select t.flow_id
                                  from T_GENERALPROCESS_MODELTWO t
                                 where t.TASKNAME like '发起合同预审%')) t4
                     on t1.flow_id = t4.f_id
                  GROUP BY t1.LOANCATEGORY,
                           t2.ORGNAME,
                           t3.ORGNAMETWO,
                           t1.ONECATEGORY,
                           t1.REPORTTIME
                  ORDER BY t1.LOANCATEGORY) tt
          left join (SELECT t1.LOANCATEGORY,
                            t1.ONECATEGORY,
                            t2.ORGNAME,
                            t3.ORGNAMETWO,
                            t1.REPORTTIME,
                            count(*) rejection_number
                       from (select T.flow_id,
                                    T.ORGCODEONE,
                                    T.ORGCODETWO,
                                    T.LOANCATEGORY,
                                    T.ONECATEGORY,
                                    M.REPORTTIME
                               from T_GENERALPROCESS_MODELONE   T,
                                    T_GENERALPROCESS_MODELTHREE M
                              where T.flow_id = M.flow_id) t1
                       join (SELECT ORGCODE, ORGNAME FROM OM_ORGANIZATION) t2
                         on t1.ORGCODEONE = t2.ORGCODE
                       LEFT join (SELECT ORGCODE as ORGCODETWO,
                                        ORGNAME as ORGNAMETWO
                                   FROM OM_ORGANIZATION) t3
                         on t1.ORGCODETWO = t3.ORGCODETWO
                       JOIN (select a.execution_ f_id
                              from jbpm4_hist_actinst a
                             where a.transition_ != 'TO 结束'
                               and a.execution_ in
                                   (select t.flow_id
                                      from T_GENERALPROCESS_MODELTWO t
                                     where t.TASKNAME like '发起合同预审%')) t4
                         on t1.flow_id = t4.f_id
                      GROUP BY t1.LOANCATEGORY,
                               t2.ORGNAME,
                               t3.ORGNAMETWO,
                               t1.ONECATEGORY,
                               t1.REPORTTIME
                      ORDER BY t1.LOANCATEGORY) gg
            on tt.LOANCATEGORY = gg.LOANCATEGORY
           and tt.ORGNAME = gg.ORGNAME
           and tt.ORGNAMETWO = gg.ORGNAMETWO
where 1=1
        <isNotNull prepend="and" property="stratdate" >
             <![CDATA[tt.REPORTTIME>=#stratdate#]]>
        </isNotNull>     
        <isNotNull prepend="and" property="enddate" >
             <![CDATA[tt.REPORTTIME<=#enddate#]]>
        </isNotNull>
      	<isNotNull prepend="and" property="oneCategory" >
                 tt.ONECATEGORY  in($oneCategory$)
      	</isNotNull>
      	<isNotNull prepend="and" property="loanCategory" >
           	     tt.LOANCATEGORY in($loanCategory$)
      	</isNotNull>

 )
		

      		
	</select>
</sqlMap>