<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="T_REPORTREFUSALRATE_SqlMap">
 <resultMap id="ReportRefusalrate" class="com.gotop.reportjbpm.model.ReportRefusalrate" >
    <!--Bean方式返回全表-->
    
    <result column="STARTDATE" property="stratdate" jdbcType="VARCHAR" />
    <result column="ENDDATE" property="enddate" jdbcType="VARCHAR" />
    <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
  
    <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
   <result column="ORGNAME" property="orgname" jdbcType="VARCHAR" />
   <result column="ORGNAMETWO" property="orgnametwo" jdbcType="VARCHAR" />
    <result column="EA_NUMBER" property="EA_number" jdbcType="VARCHAR" />
    <result column="REJECTION_NUMBER" property="rejection_number" jdbcType="VARCHAR" />

    <result column="REFUSALRATE" property="refusalrate" jdbcType="VARCHAR" />
  </resultMap>
  
 
   
	
	
	
	
	<!-- 查询拒贷信息 -->
	<select id="queryReportRefusalRate" parameterClass="java.util.HashMap" resultMap="ReportRefusalrate">
		SELECT tt.LOANCATEGORY,tt.ORGNAME,tt.ORGNAMETWO,tt.EA_number,gg.rejection_number,(round(gg.rejection_number/(tt.EA_number+gg.rejection_number)*100,2))||'%'  as  refusalrate,tt.STARTDATE, tt.ENDDATE,tt.ONECATEGORY  from 
(
SELECT t1.LOANCATEGORY,t1.ONECATEGORY,t2.ORGNAME,t2.STARTDATE,t2.ENDDATE,t3.ORGNAMETWO,count(*) EA_number from
(select flow_id,ORGCODEONE,ORGCODETWO,LOANCATEGORY,ONECATEGORY from 
T_GENERALPROCESS_MODELONE ) t1 
join (SELECT ORGCODE,ORGNAME,STARTDATE,ENDDATE  FROM  OM_ORGANIZATION) t2 on t1.ORGCODEONE=t2.ORGCODE 
LEFT join (SELECT ORGCODE as ORGCODETWO,ORGNAME as ORGNAMETWO FROM  OM_ORGANIZATION) t3 on t1.ORGCODETWO=t3.ORGCODETWO
JOIN (select a.execution_ f_id from jbpm4_hist_actinst a where a.transition_ = 'TO 结束' and a.execution_ in(
select t.flow_id from  T_GENERALPROCESS_MODELTWO t where t.TASKNAME like '发起合同预审%')) t4 on t1.flow_id=t4.f_id
GROUP BY t1.LOANCATEGORY,t2.ORGNAME,t3.ORGNAMETWO,t1.ONECATEGORY,t2.STARTDATE,t2.ENDDATE
ORDER BY t1.LOANCATEGORY)tt
left join
(
SELECT t1.LOANCATEGORY,t1.ONECATEGORY,t2.ORGNAME,t2.STARTDATE,t2.ENDDATE,t3.ORGNAMETWO,count(*) rejection_number from
(select flow_id,ORGCODEONE,ORGCODETWO,LOANCATEGORY,ONECATEGORY from 
T_GENERALPROCESS_MODELONE ) t1 
join (SELECT ORGCODE,ORGNAME,STARTDATE,ENDDATE FROM  OM_ORGANIZATION) t2 on t1.ORGCODEONE=t2.ORGCODE 
LEFT join (SELECT ORGCODE as ORGCODETWO,ORGNAME as ORGNAMETWO FROM  OM_ORGANIZATION) t3 on t1.ORGCODETWO=t3.ORGCODETWO
JOIN (select a.execution_ f_id from jbpm4_hist_actinst a where a.transition_ != 'TO 结束' and a.execution_ in(
select t.flow_id from  T_GENERALPROCESS_MODELTWO t where t.TASKNAME like '发起合同预审%')) t4 on t1.flow_id=t4.f_id
GROUP BY t1.LOANCATEGORY,t2.ORGNAME,t3.ORGNAMETWO,t1.ONECATEGORY,t2.STARTDATE,t2.ENDDATE
ORDER BY t1.LOANCATEGORY)gg
on tt.LOANCATEGORY=gg.LOANCATEGORY and tt.ORGNAME=gg.ORGNAME and tt.ORGNAMETWO=gg.ORGNAMETWO

      <isNotNull prepend="and" property="stratdate" >
        t2.STARTDATE = #stratdate:VARCHAR#
      </isNotNull>
      <isNotNull prepend="and" property="enddate" >
        t2.ENDDATE =#enddate:VARCHAR#
      </isNotNull>
   
      		<isNotNull prepend="and" property="oneCategoryId" >
           	tt.oneCategory in(select dic.dictname from eos_dict_entry dic where dic.dicttypeid='PROCESS_onecategory' 
           	 and dic.dictid in($oneCategoryId$))
      		</isNotNull>
      		 <isNotNull prepend="and" property="loanCategoryId" >
           	 tt.loanCategory in(select dic.dictname from eos_dict_entry dic where dic.dicttypeid='PROCESS_credit_type' 
           	 and dic.dictid in($loanCategoryId$))
      		</isNotNull>
      		
		
		
		
		
		
		
		
		

		
 





  
  
  
   
    
      		
      		
      		
      		
	</select>
	
	
</sqlMap>