<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="T_PASSRATEREPORT_SqlMap">
 <resultMap id="PassRateReport" class="com.gotop.reportjbpm.model.PassRateReport" >
    <!--Bean方式返回全表-->
    <result column="ORGNAMEONE" property="orgNameOne" jdbcType="VARCHAR" />
    <result column="ORGNAMETWO" property="orgNameTwo" jdbcType="VARCHAR" />
    <result column="ONECATEGORY" property="oneCategory" jdbcType="VARCHAR" />
    <result column="LOANCATEGORY" property="loanCategory" jdbcType="VARCHAR" />
    <result column="REVIEW_EMP_NAME" property="reviewEmpname" jdbcType="VARCHAR" />
    <result column="APPROVAL_EMP_NAME" property="approvalEmpname" jdbcType="VARCHAR" />
    <result column="businessNumberOne" property="businessNumberOne" jdbcType="VARCHAR" />
    <result column="businessNumberTwo" property="businessNumberTwo" jdbcType="VARCHAR" />
    <result column="businessNumberThree" property="businessNumberThree" jdbcType="VARCHAR" />
    <result column="businessNumberMoreThree" property="businessNumberMoreThree" jdbcType="VARCHAR" />
    <result column="businessNumberMoreFour" property="businessNumberMoreFour" jdbcType="VARCHAR" />
  </resultMap>
	
	<!-- 通过率统计 -->
	<select id="queryPassRateReport" parameterClass="java.util.HashMap" resultMap="PassRateReport">
SELECT 
ORGCODEONE,
ORGCODETWO,
ONECATEGORY,
LOANCATEGORY,
REVIEW_EMP_NAME,
APPROVAL_EMP_NAME,
( select ORGNAME from OM_ORGANIZATION where orgcode=ORGCODEONE) AS ORGNAMEONE,
( select ORGNAME from OM_ORGANIZATION where orgcode=ORGCODETWO) AS ORGNAMETWO,
sum(businessNumberOne) businessNumberOne,sum(businessNumberTwo) businessNumberTwo,sum(businessNumberThree) businessNumberThree,
sum(businessNumberMoreThree) businessNumberMoreThree,sum(businessNumberMoreFour) businessNumberMoreFour
from 
(

SELECT   ORGCODEONE,
         ORGCODETWO,
         ONECATEGORY,
         LOANCATEGORY,    
         REVIEW_EMP_NAME,
         APPROVAL_EMP_NAME,
CASE WHEN cnt = 1 THEN  1 ELSE  0 END businessNumberOne,  
CASE WHEN cnt = 2 THEN  1 ELSE  0 END businessNumberTwo,  
CASE WHEN cnt = 3 THEN  1 ELSE  0 END businessNumberThree,
CASE WHEN cnt > 3 THEN  1 ELSE  0 END businessNumberMoreThree,  
CASE WHEN cnt > 4 THEN  1 ELSE  0 END businessNumberMoreFour 
FROM
  (
    SELECT
       ORGCODEONE,
       ORGCODETWO,
      ONECATEGORY,
      LOANCATEGORY,
      ACTIVITY_NAME_,
      OPERATORNAME,
      REVIEW_EMP_NAME,
      APPROVAL_EMP_NAME,
      COUNT (ACTIVITY_NAME_) cnt
    FROM
      (
        SELECT
          EXECUTION_,
          ACTIVITY_NAME_,
          END_,
          OPERATORNAME,
          ORGCODEONE,
          ORGCODETWO,
          ONECATEGORY,
          LOANCATEGORY,  
          substr(PRE_TASK_TIME ,0,8) as PRE_TASK_TIME,     
         ( select empname from om_employee where empid = REVIEWEMPID) as REVIEW_EMP_NAME,
         ( select empname from om_employee where empid = APPROVALEMPID) as APPROVAL_EMP_NAME
        FROM
          (
            SELECT
              tt.EXECUTION_,
              tt.ACTIVITY_NAME_,
              tt.END_,
              t2.OPERATORNAME,
              t3.ORGCODEONE,
              t3.ORGCODETWO,
              t3.ONECATEGORY,
              t3.LOANCATEGORY,
              t4.REPORTTIME,
              t8.pre_task_assingee as REVIEWEMPID,
              t7.PRE_TASK_TIME,
              t9.pre_task_assingee as APPROVALEMPID
            FROM
              JBPM4_HIST_ACTINST tt
            LEFT JOIN JBPM4_HIST_TASK t1 ON TT.HTASK_ = T1.DBID_
            LEFT JOIN ac_operator t2 ON t1.ASSIGNEE_ = t2.OPERATORID
            LEFT JOIN T_GENERALPROCESS_MODELONE t3 ON tt.EXECUTION_ = t3.flow_id
            LEFT JOIN T_GENERALPROCESS_MODELTHREE t4 ON t4.flow_id = tt.EXECUTION_
            LEFT JOIN (
                 SELECT *
                          FROM
                            (SELECT execution_id,
                                    pre_task_id,
                                    pre_task_assingee,
                                    next_activity_name,
                                    PRE_TASK_TIME
                             FROM t_Process_Task_Assignee
                             WHERE business_type = '88'
                             and next_activity_name = '收单派单' 
                             )
            ) t6 ON tt.EXECUTION_ = t6.execution_id
            LEFT JOIN (
                 SELECT *
                          FROM
                            (SELECT execution_id,
                                    pre_task_id,
                                    pre_task_assingee,
                                    next_activity_name,
                                    PRE_TASK_TIME
                             FROM t_Process_Task_Assignee
                             WHERE business_type = '88'
                             and next_activity_name = '审查一' 
                             )
            ) t7 ON t6.execution_id = t7.execution_id 
            LEFT JOIN (
                 SELECT *
                          FROM
                            (SELECT execution_id,
                                    pre_task_id,
                                    pre_task_assingee,
                                    next_activity_name,
                                    PRE_TASK_TIME
                             FROM t_Process_Task_Assignee
                             WHERE business_type = '88'
                             and next_activity_name = '审查一' 
                             )
            ) t8 ON tt.EXECUTION_ = t8.execution_id
           LEFT JOIN (
                 SELECT *
                          FROM
                            (SELECT execution_id,
                                    pre_task_id,
                                    pre_task_assingee,
                                    next_activity_name
                             FROM t_Process_Task_Assignee
                             WHERE business_type = '88'
                             and next_activity_name = '发起合同预审' 
                             )
            ) t9 ON tt.EXECUTION_ = t9.execution_id
            WHERE
              HPROCI_ IN (
                SELECT
                  DBID_
                FROM
                  JBPM4_HIST_PROCINST T
                WHERE
                  T .PROCDEFID_ IN (
                    SELECT
                      DEFINITION_ID
                    FROM
                      T_PROCESS_CONFIG T
                    WHERE
                      BUSINESS_TYPE = '88'
                  )
              )
          )
        WHERE
          end_ IS NOT NULL
          and ACTIVITY_NAME_ = '发起合同预审'
          <isNotNull prepend="and" property="repTimeStrat" >
         <![CDATA[
            PRE_TASK_TIME >= #repTimeStrat#
               ]]>
      </isNotNull>
      <isNotNull prepend="and" property="repTimeEnd" >
        <![CDATA[
            PRE_TASK_TIME <=  #repTimeEnd#
               ]]>
      </isNotNull>
      <isNotNull prepend="and" property="orgCodeOne" >
           ORGCODEONE = '$orgCodeOne$'
      </isNotNull>
      <isNotNull prepend="and" property="orgCodeTwo" >
           ORGCODETWO = '$orgCodeTwo$'
      </isNotNull>
      <isNotNull prepend="and" property="oneCategory" >
            ONECATEGORY in(select dic.dictname from eos_dict_entry dic where dic.dicttypeid='PROCESS_onecategory' 
           	 and dic.dictid in($oneCategory$))
      </isNotNull>
      <isNotNull prepend="and" property="loanCategory" >
          LOANCATEGORY in(select dic.dictname from eos_dict_entry dic where dic.dicttypeid='PROCESS_credit_type' 
           	 and dic.dictid in($loanCategory$))
      </isNotNull>
     
        
      )
    GROUP BY
      EXECUTION_,
      ORGCODEONE,
      ORGCODETWO,
      ONECATEGORY,
      LOANCATEGORY,
       REVIEW_EMP_NAME,
      APPROVAL_EMP_NAME
)
)
GROUP BY
ORGCODEONE,
ORGCODETWO,
ONECATEGORY,
LOANCATEGORY,
REVIEW_EMP_NAME,
APPROVAL_EMP_NAME
	</select>

</sqlMap>